# Superstore Database Project

This project is a SQL-based implementation of a superstore database, including tables for product details, customer details, order details, billing details, and shipping details. It covers various SQL operations, such as inserting, deleting, updating, and selecting data. Additionally, it includes examples of triggers, functions, views, and procedures for more complex database operations.

## Table of Contents
- [Database Schema](#database-schema)
- [SQL Operations](#sql-operations)
- [Triggers, Functions, Views, Procedures](#triggers-functions-views-procedures)
- [Optimizations](#optimizations)

## Database Schema

The database schema includes the following tables:
- `Product_Details`
- `Customer_Details`
- `Order_Details`
- `Billing_Details`
- `Shipping_Details`
- `Order_Product`
- `Order_Customer`

## SQL Operations

### Inserting Operation

1. Insert a new product into the Product_Details table:

    ```sql
    INSERT INTO Product_Details (Product_ID, Product_Name, Category, Sub_Category, unit_price, Sales, Row_ID)
    VALUES ('TEC-CO-5800', 'Lenovo IdeaPad 5', 'Technology', 'Computers', 1000, 500000, 324);
    ```

### Deleting Operation

2. Delete a product from the Product_Details table:

    ```sql
    DELETE FROM Product_Details
    WHERE Product_ID = 'TEC-CO-5800';
    ```

### Updating Operation

3. Update the unit price of a product in the Product_Details table:

    ```sql
    UPDATE Product_Details
    SET unit_price = 625.00
    WHERE Product_ID = 'TEC-PH-5356';
    ```

### Select Operation

4. Select all the orders made by a specific customer:

    ```sql
    SELECT *
    FROM Order_Details
    WHERE Customer_ID = 'HI-185111';
    ```

## Triggers, Functions, Views, Procedures

### View

5. Create a view that shows the total sales for each product by year:

    ```sql
    CREATE VIEW product_sales_by_year AS
    SELECT pd.product_id, pd.product_name, DATE_TRUNC('year', od.order_date) AS year, SUM(bd.sales) AS total_sales
    FROM product_details pd
    INNER JOIN order_details od ON pd.product_id = od.product_id
    INNER JOIN billing_details bd ON od.order_id = bd.order_id
    GROUP BY pd.product_id, pd.product_name, DATE_TRUNC('year', od.order_date);
    ```

### Trigger

6. Create a trigger that automatically inserts a new record into the Shipping_Details table whenever a new order is inserted into the Order_Details table:

    ```sql
    -- CREATE OR REPLACE FUNCTION insert_shipping_details()
    RETURNS TRIGGER AS $$
    BEGIN
      -- Try to update the existing record with the new values
      UPDATE Shipping_Details
      SET Order_Date = NEW.Order_Date,
          Order_Priority = NEW.Order_Priority,
          Ship_Mode = NEW.Ship_Mode,
          Country = (SELECT Country FROM Customer_Details WHERE Customer_ID = NEW.Customer_ID),
          State = (SELECT State FROM Customer_Details WHERE Customer_ID = NEW.Customer_ID),
          Region = (SELECT Region FROM Customer_Details WHERE Customer_ID = NEW.Customer_ID),
          City = (SELECT City FROM Customer_Details WHERE Customer_ID = NEW.Customer_ID)
      WHERE Order_ID = NEW.Order_ID;
      
      
      -- If no record was updated, insert a new one
      IF NOT FOUND THEN
        INSERT INTO Shipping_Details (Order_ID, Order_Date, Order_Priority, Ship_Mode, Country, State, Region, City)
        SELECT NEW.Order_ID, NEW.Order_Date, NEW.Order_Priority, NEW.Ship_Mode, c.Country, c.State, c.Region, c.City
        FROM Customer_Details c
        WHERE c.Customer_ID = NEW.Customer_ID;
      END IF;
      
      RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;
    
    CREATE TRIGGER trg_insert_shipping_details
    AFTER INSERT ON Order_Details
    FOR EACH ROW
    EXECUTE FUNCTION insert_shipping_details();
        ```

### Procedure

7. Create a procedure to calculate the total revenue generated by a customer in a particular year:

    ```sql
    -- CREATE OR REPLACE PROCEDURE calculate_customer_revenue(
    IN customer_name varchar(255),
    IN year int,
    OUT revenue double precision)

    AS $$
        BEGIN
            SELECT SUM(bd.Sales) INTO revenue
            FROM Order_Details od
            JOIN Billing_Details bd ON od.Order_ID = bd.Order_ID
            JOIN Customer_Details cd ON od.Customer_ID = cd.Customer_ID
            WHERE cd.Customer_Name = calculate_customer_revenue.customer_name
            AND extract(year from od.Order_Date) = year;
        END;
        $$ LANGUAGE plpgsql;
        
        
        DO $$
        DECLARE
            v_revenue double precision;
        BEGIN
            CALL calculate_customer_revenue('Stacy Cruz', 2014, v_revenue);
            RAISE NOTICE 'Revenue for Stacy Cruz in 2014: %', v_revenue;
        END $$;
    ```

## Optimizations

8. Optimize the query to retrieve the top 10 customers with the highest total sales:

    ```sql
    -- After optimization
    CREATE MATERIALIZED VIEW customer_sales AS
    SELECT od.Customer_ID,
           COALESCE(SUM(pd.unit_price * od.quantity), 0) AS Total_Sales
    FROM Product_Details pd 
    INNER JOIN Order_Details od ON pd.Product_ID = od.Product_ID 
    GROUP BY od.Customer_ID;
    
    SELECT c.customer_name, c.Country, c.state, 
           (SELECT COUNT(*) FROM Order_Details WHERE Customer_ID = c.Customer_ID) AS Total_Orders,
           cs.Total_Sales,
           (SELECT COUNT(*) FROM Shipping_Details WHERE Order_ID IN 
                (SELECT Order_ID FROM Order_Details WHERE Customer_ID = c.Customer_ID)) AS Total_Shipments
    FROM Customer_Details c
    LEFT JOIN customer_sales cs ON c.Customer_ID = cs.Customer_ID
    ORDER BY cs.Total_Sales DESC
    LIMIT 10;
    ```

9. Optimize the query to update product sales:

    ```sql
    CREATE OR REPLACE FUNCTION update_sales()
    RETURNS TRIGGER AS
    $$
    BEGIN
        UPDATE Product_Details
        SET Sales = NEW.unit_price * (
            SELECT SUM(od.quantity) 
            FROM Order_Details od 
            WHERE od.product_id = NEW.product_id
        )
        WHERE Product_ID = NEW.Product_ID;
        RETURN NEW;
    END;
    $$
    LANGUAGE plpgsql;
    
    CREATE TRIGGER update_sales_trigger
    AFTER UPDATE OF unit_price ON Product_Details
    FOR EACH ROW
    EXECUTE FUNCTION update_sales();
    
    UPDATE Product_Details SET unit_price = 625.00 WHERE Product_ID = 'TEC-PH-5356';
    
    select * from Product_Details where Product_ID = 'TEC-PH-5356';
    ```

## Contributors

- [Akanksh Gatla][https://github.com/Akankshg-ByteWizard]

Feel free to contribute to this project by opening issues or submitting pull requests.
